// -- ----------------------------
// -- Table structure for jt_fiction_chapter
// -- ----------------------------
// DROP TABLE IF EXISTS `jt_fiction_chapter`;
// CREATE TABLE `jt_fiction_chapter`  (
//   `id` int(11) NOT NULL AUTO_INCREMENT,
//   `fid` int(11) NULL DEFAULT 0 COMMENT '小说id',
//   `name` varchar(30) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT '' COMMENT '章节名字',
//   `content` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL COMMENT '章节内容',
//   `sort` int(11) NULL DEFAULT 0 COMMENT '排序',
//   `created_time` datetime(0) NULL DEFAULT NULL COMMENT '写入时间',
//   `updated_time` datetime(0) NULL DEFAULT NULL COMMENT '更新时间',
//   PRIMARY KEY (`id`) USING BTREE
// ) ENGINE = InnoDB AUTO_INCREMENT = 77 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci COMMENT = '小说章节表' ROW_FORMAT = Dynamic;

// -- ----------------------------
// -- Records of jt_fiction_chapter
// -- ----------------------------
// INSERT INTO `jt_fiction_chapter` VALUES (36, 13, '第一章', '　　节哥，这小娘们怎么处理？老虎问。\n　　沈知节低着头用布条缠手掌上的血口子，闻言瞥一眼缩在车轮旁瑟瑟发抖的女人，神色依旧淡漠，干净点，别留后患。\n　　很好听的声音，音色干净微沉，却又隐隐透着凉意。\n　　瞧好吧您那！老虎应了一声，提了根尺多长的铁棍子往女人那走。\n　　那是根拇指粗的螺纹钢筋，是何妍从建筑工地上捡回来的，就放在副驾驶座前的工具箱里，她本来是用来防身的，放那个的时候，怎么也没想到它会落到歹徒手里，成为要她性命的凶器。\n　　活下去，无论如何也要活下去！\n　　何妍身体抖得如同筛糠，心里却有个声音在狂喊，她双亲尚在，一辈子温顺良和，绝接受不了她惨死野外，而且，她还有梁远泽，他在等着她过去相聚。\n　　她真的不该独自开车走这条乡间公路，不该以为开着车就安全，更不该在看到路面上趴着个人时就好心地踩了刹车??她真该踩一脚油门直接压过去的！\n　　可现在不是后悔自责的时候，她正濒临着死亡。\n　　求求你们，别杀我，车、钱我全给你们！我也绝不会报警，只求求你们别杀我！她怯怯地哭着，跪伏着往路边上坐着的那个眉目冷厉的男人身前爬了两步，哀求：大哥，求您别杀我，看在我刚才停车救您的份上，您放了我行吗？我绝对不会乱说话的，今天晚上我什么也没看到，什么也没遇到，真的，真的！\n　　这是一个还算聪明的女人，沈知节不禁抬眼多看了她一眼，泪涕横流的脸，五官端正秀气，却因恐惧而微微变形，眼睛里都是泪，闪着渴求的光芒。不过，这并不能软化他冷硬的心，他依旧无动于衷，又低下头去包扎手上伤口，那是他从货车上跳下时伤到的，手掌摁到了路边一块带着利茬的石头上，差点被割成了两半。\n　　女人还在他脚边不停地磕头哭求，他觉得有些烦躁，单手系结又不方便，只得把手掌伸递给了身边的瘦猴，又冷声问老虎：还磨叽什么？\n　　老虎走过来，像拎小鸡仔一样把她拎了起来，往路边草丛里拖。\n　　何妍奋力地挣扎着，却不敢尖叫，在这个前不找村后不着店的荒郊野外，叫了也不会有人来，只能叫她死得更快些，所以，她依旧只是哀求，哭着哀求。\n　　老虎，等一下！倒是给沈知节包扎手掌的瘦猴心先软了，出声叫住老虎，又小心地请示沈知节：节哥，先留着这女人吧，就她这样的，还能把咱们怎么着呀？\n　　沈知节剑眉微皱，抿唇不语，老虎却忍不住讥笑兄弟：你是小子色心动了吧？\n　　瘦猴嘿嘿笑，目光在何妍因挣扎而愈显饱满的胸口打了个转，毫不遮掩自己的情欲，反问老虎：动了又怎么样？都一个多月没碰女人了，难道你小子不想？\n　　借着明亮的月光，老虎低头看手里拎着的女人，也忍不住有点动心，这的确是个年轻漂亮的女人，五官精致，身材诱人。\n　　他两个都有些动摇，齐齐看向沈知节。\n　　沈知节冷漠狠厉的视线从已被吓傻了的何妍身上扫过，吐出的字眼冰冷无情，我们正在逃命，要玩女人等安全了随便你们玩。\n　　何妍不受控制地瑟缩了一下，她竭力不要自己晕过去，把哀求的目光投向那个瘦猴一样的男人，争取这唯一活命的机会，小哥，只要你们别杀我，我什么都愿意做，我家里还有父母，他们就我一个女儿。\n　　瘦猴实在是动心，又硬着头皮，嬉皮笑脸地去求沈知节：节哥，就现在玩也耽误不了多少时间的。\n　　沈知节还未有所表示，老虎倒是先忍不住笑了，骂道：瞧你这点出息！\n　　虽这样骂着，却也没继续把何妍往远处拖，和瘦猴一同眼巴巴地瞅着自家老大。\n　　这是跟着他一起出生入死的两个兄弟，沈知节抬眼扫了扫他们，顺手从路边掐了根草径叼进嘴里，棱角分明的脸庞上第一次露出冷漠之外的神色，颇有些不耐烦地说道：你们两个动作迅速点！\n　　瘦猴欢呼了一声从他身边一跃而起，径直向何妍走过来，老虎笑了笑，很大方地松开了手，让你小子占个先。\n　　何妍没有躲避，顺从地就着瘦猴的力道，只不停地央求他：小哥，你别杀我，我求求你别杀我，我真的什么也不会说的。\n　　不杀你，我不杀你，只要你乖乖听话！瘦猴口中应付着，手却急不可耐地先往何妍胸口上重重抓了一把，布料下那女性特有的温软柔腻盈满他的手掌，他更加着急了，四下里扫望了一眼，急慌慌地把她往草丛里扯。\n　　车里，咱们去车里吧。何妍声音细若蚊鸣，却依旧惊动了远处那个男人，两道冰冷的视线往她身上落过来，吓得她又赶紧磕磕巴巴地解释：车后座还舒服点，不扎人。\n　　瘦猴被色迷了心窍，就真的扯着她往路中间的那辆车去了，一把拽开后座车门，把她推了进去。沈知节冷冷地瞧着这边，向老虎微微偏了下头，老虎明白了他的意思，抱着怀在后面跟了上去。\n　　车是一辆白色的SUV，车身高大宽敞，老虎倚靠在车身上，透过半开的车窗玻璃，和车里的瘦猴开玩笑：你小子还行吗？\n　　瘦猴含糊不清地骂了声滚蛋，车里传来一阵衣料的摩擦声和女人的几声闷吭，在一声压抑的、痛苦的呜咽之后，很快，伴随着男人兴奋的低喘，车身一下下有节奏地上下震了起来。\n　　草！老虎身体有了反应，忍不住骂了一声，起身离开车身往前走了两步，回头骂车里的人：猴子，你他妈悠着点！\n　　这丫头还是个雏！瘦猴的声音里透着惊喜和得意，气喘吁吁地叫道：老子今天才是赚到了！\n　　老虎愣了一下，往地上啐了口吐沫，又笑着向不远处一直沉默着的沈知节，节哥，瞅瞅这劲头，别他妈把车再给咱摇散架了！\n　　竟还是个雏？倒是叫人意想不到。沈知节轻轻地扯了下嘴角，露出些许嘲弄，缓缓地收回了视线。\n　　车子还在不停地摇晃着，这节奏又刺激了车里的人，叫他顶撞得越发卖力，嘴里胡乱叫着心肝宝贝，屡次凑过来试图亲吻身下的人。\n　　何妍咬着唇忍耐，尽管她已经努力打开自己的身体，可剧烈的疼痛依旧不能避免。她深吸一口气，单臂搂住男人的脖子，忍受着他的侵犯，不露痕迹地把他的身体往下压，另只手却偷偷地摸向副驾驶椅背后的袋子。\n　　那里有一把刀，很小却很锋利的水果刀。上次梁远泽开车带她去春游，回来的路上她发懒在后座上睡觉，睡醒后就是用那把刀给他削的水果。那时她就坐在后座上，用小刀把苹果切成小块，再喂进梁远泽的嘴里，他会突然叼住她的手指，在她的惊叫声中使坏地用舌尖舔她的指尖，不肯松开。\n　　她得活下去，何妍在心里一遍遍地告诉自己，爸爸，妈妈，还有远泽，他们都还在等着她，她不能死在这里，死在这样一场屈辱的、不堪的奸杀里。\n　　何妍终于摸到了那把刀，而这个凶徒还压在她的身上施暴，她却从未像此刻这样冷静过，手滑过他的背，试图确认心脏的位置，可她不能确定，又怕刀子太短，一刀下去刺不穿他的心脏，无法一击夺命。\n　　身上男人的速度在加快，何妍知道自己没有时间再犹豫了，她勾住他的后脑，扬起头用力堵住了他的嘴。男人并不知她的企图，甚至有点惊喜她的反应，双手紧紧搂着她的腰肢，拼命地亲吻她。\n　　就在他身体不受控制地绷紧那一瞬，何妍手中的刀毫不犹豫地刺进了他的后颈。\n　　那也是能一刀毙命的地方，男人干瘦的身体于一瞬间僵滞，他拼命地往上抬头，瞪大了眼睛，似是想要看清被他压在身下的女人。可惜他再没机会了，何妍的双腿紧紧地盘住他的下肢，手上死死地摁在他的后脑，另只手握住刀柄，使尽了力气地往下划去，颈椎、大动脉、喉管??所有的一切在锐利的刀锋下都不堪一击。\n　　这真是一把好刀，不亏她大老远地从瑞士带回来。\n　　血喷洒一般地往外窜，她不得不伸手去捂，半个身体都被浸湿，视线几乎被血糊住，身上的人才终于停止了挣扎，温热的身体只剩下了隐隐的抽搐。何妍却不敢随意松手，她偷偷地瞥向车外，凶悍高大的男人立在车外不远处，而另外那个节哥则坐在更前面。\n　　车子一直没熄火，她当初下车查看的时候就没灭车。她必须不惊动他们，快速地爬到前面去，锁上车门，然后开车逃走。\n　　这是她唯一能够活命的机会。\n　　何妍深吸了口气，轻轻地推开了还压在她身上的干瘦男人。\n　　沈知节在闭目养神，同时也在思考接下来该怎么走，他们已经逃出来一千多公里，南昭市就在不远的地方，可前途依旧莫测。也许，他真不该在这个时候放纵老虎和瘦猴两个。可他们两个一路跟着他杀出来，逃亡的三十多个日夜里没有一天放松过，就任他们荒唐个把小时又能怎样？\n　　他有些失神，一直紧绷的神经也有点松懈，甚至叫他都没能在第一时间听到车门上锁时发出的那一声轻响。怕引人注意而熄灭的车灯猛地亮了起来，他有些错愕地抬头，就看到那辆白色的SUV发疯一般向他歇冲了过来。\n　　强烈的灯光叫他有短暂的失明，可只一需眼他就看清了开车的人，是刚才那个只知道哭泣哀求的女人，现在带着半脸的鲜血，另外半张却惨白得如同鬼魅，只有那双眼睛还是那样漆黑，没了泪水的掩盖，充满了疯狂的恨意，亮得灼目。\n　　节哥——老虎惊叫，毫不犹豫地扑过来，把来不及起身的他推向一边，不用思考，沈知节身体本能地往路边滚去，车轮擦着他的肩头而过，而老虎却被车头撞飞，直出去十多米远才落下来，发出一声沉闷的声音。\n　　那车丝毫未停，径直碾过老虎的双腿，扬长而去。\n　　何妍双手死死地握着方向盘，只知道猛踩油门，车子沿着乡间公路一直往前疯飙，直到冲上城市里明亮的街道，这才猛地刹住。她整个身体都在不受控制地抖动，手抖动连手机都握不住，更别说按下梁远泽的号码。\n　　啊——她如野兽般发出一声低低的低吼，张口用力咬住自己的手腕，直到那疼痛遏止住抖动，这才能摁通了梁远泽的电话，泣不成声地说道：报警，远泽，报警，我出事了。\n　　她深夜独自开车来到他所在的城市，原本，只是想给他一个惊喜的。', 1, '2020-07-17 19:28:55', NULL);

import SqlClient from "./sql-client";
import Jt from "./jt";
import Logger from "./logger";
import Axios from "./axios";
import DateFormat from "./date-format";

const logger = new Logger("jt-fiction-chapters");

export default class JtFictionChapter implements Jt {
	// tslint:disable-next-line: variable-name
	fid: number = 0; // 小说id

	name: string = ""; // 章节名字

	content: string = ""; // 章节内容

	sort: number = 0; // 排序

	// tslint:disable-next-line: variable-name
	created_time: string; // 写入时间

	// tslint:disable-next-line: variable-name
	updated_time: string; // 更新时间

	wid: number; // 抓包到的小说id

	constructor(data: any) {
		const time = new DateFormat(new Date()).format();
		this.fid = data.fid;
		this.name = data.chaptername;
		this.content = data.content;
		this.sort = data.sort;
		this.created_time = time;
		this.updated_time = time;
		this.wid = data.bookid;
	}

	async getId() {
		const sql = `select id from \`jt_fiction_chapter\` where wid=${this.wid} and name="${this.name}"`;
		const result: any[] = await SqlClient.getInstance().query(sql);
		let id = 0;
		if (result.length > 0) {
			id = result[0].id;
		}
		return id;
	}

	async insert() {
		const id = await this.getId();
		const sql = `INSERT INTO \`jt_fiction_chapter\` VALUES (
			${id},
			${this.fid},
			"${this.name}",
			"${this.content}",
            ${this.sort},
            "${this.created_time}",
			"${this.updated_time}",
			${this.wid})
			ON DUPLICATE KEY UPDATE
            content="${this.content}",
            sort=${this.sort},
			updated_time="${new DateFormat(new Date()).format()}",
			wid=${this.wid}`;
		return SqlClient.getInstance().query(sql);
	}

	static MAX_RETRY_COUNT = 3;

	static async getLocalChapter(fid: number, name: string) {
		const sql = `select * from \`jt_fiction_chapter\` where fid=${fid} and name="${name}"`;
		const result: any[] = await SqlClient.getInstance().query(sql);
		return result.length > 0 ? result[0] : null;
	}

	static async getRemoteChapter(
		bookid: number,
		chapterid: number,
		chaptername: string,
		sort: number
	) {
		let retry = 0;

		const _update = async () => {
			try {
				const instance = await this.getLocalChapter(
					bookid,
					chaptername
				);
				logger.d(
					`get chapter info, exits=${
						instance != null
					}, bookid=${bookid}, chapterid=${chapterid}, chaptername=${chaptername}`
				);
				if (instance == null) {
					const r = await Axios.getInstance().getChapterInfo(
						bookid,
						chapterid
					);
					const fid = await JtFictionChapter.getFId(bookid);
					const chapter = new JtFictionChapter({
						bookid,
						chaptername,
						content: r.data.result.content,
						sort,
						fid,
					});
					await chapter.insert();
				}
			} catch (e) {
				retry++;
				if (retry <= this.MAX_RETRY_COUNT) {
					_update();
				} else {
					logger.e(
						`get chapter info fail, bookid=${bookid}, chapterid=${chapterid}, chaptername=${chaptername}, message=${e.message}`
					);
				}
			}
		};

		return new Promise(async (resolve, _) => {
			await _update();
			resolve();
		});
	}

	static async update() {
		logger.d(`update`);
		const books = await Axios.getInstance().getBooks();
		for (const b of books) {
			const { bookid, bookname } = b;
			try {
				logger.d(
					`get chapters, bookid=${bookid}, bookname=${bookname}`
				);
				const response = await Axios.getInstance().getChapters(bookid);
				const volumelist: any[] = response.data.result;
				let sort = 0;
				for (const v of volumelist) {
					const { chapterlist } = v;
					for (const c of chapterlist) {
						sort++;
						const { book_id, chapterid, chaptername } = c;
						await this.getRemoteChapter(
							book_id,
							chapterid,
							chaptername,
							sort
						);
					}
				}
			} catch (e) {
				logger.e(
					`get chapters fail, bookid=${bookid}, chaptername=${bookname}, message=${e.message}`
				);
			}
		}
		logger.d(`update done,books=${books.length}`);
	}

	static async clean() {
		const sql = "truncate table jt_fiction_chapter";
		return SqlClient.getInstance().query(sql);
	}

	static async getFId(bookid: number) {
		const sql = `select id from \`jt_fiction\` where wid="${bookid}"`;
		const result: any[] = await SqlClient.getInstance().query(sql);
		let id = 0;
		if (result.length > 0) {
			id = result[0].id;
		}
		return id;
	}
}
